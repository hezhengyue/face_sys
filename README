# docker 
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
sudo yum -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
systemctl start docker 
systemctl enable docker 
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://docker.1ms.run"
  ],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  }
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
cat  /etc/docker/daemon.json
docker info



# 首次部署流程
# 注意：请确保本地开发环境已生成 migrations 文件并提交到 Git。生产环境不执行 makemigrations。
git clone https://github.com/hezhengyue/face_sys.git
cd face_sys
cp .env.example .env
vi .env 
mkdir -p logs/django logs/nginx static media
cd docker
ln -s ../.env .env
docker compose build --no-cache
docker compose up -d
docker compose ps
docker compose exec web python manage.py createsuperuser
docker compose logs -f 


# 日常运维
# 代码更新与发布，当 git 仓库有新代码提交时（包含新的 migration 文件）：
cd face_sys
git pull
cd docker
docker compose down
docker compose build --no-cache
docker compose up -d
docker compose logs -f 
# 清理未使用的旧镜像 (可选)。每次执行docker compose build --no-cache都会生成新的docker-web镜像
docker image prune -f


# 重置并清空当前docker-compose.yml所有数据卷（谨慎使用，会删除所有数据）：
cd face_sys/docker
docker-compose down -v
docker-compose up -d

# 删除指定容器数据卷
cd face_sys/docker
docker compose stop redis
docker compose rm -f redis
docker volume ls # 查看所有卷
docker volume rm docker_redis_data # 默认是docker_redis_data，但建议使用docker volume ls 查看
docker compose up -d redis


# 防火墙设置 (Firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

