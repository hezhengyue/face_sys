# docker 
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
sudo yum -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
systemctl start docker 
systemctl enable docker 
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://registry.cn-hangzhou.aliyuncs.com",
    "https://docker.m.daocloud.io",
    "https://docker.1ms.run"
  ],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  }
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
cat  /etc/docker/daemon.json
docker info


# 首次部署流程
# 注意：请确保本地开发环境已生成 migrations 文件并提交到 Git。生产环境不执行 makemigrations。
git clone https://github.com/hezhengyue/face_sys.git
cd face_sys
cp .env.example .env
vi .env 
mkdir -p logs/face logs/import logs/system logs/user logs/nginx static media 
cd docker
ln -s ../.env .env
docker compose build --no-cache
docker compose up -d
docker compose ps
docker compose exec web python manage.py createsuperuser


# 日常运维
# 代码更新与发布，当 git 仓库有新代码提交时（包含新的 migration 文件）：
cd face_sys
git pull
cd docker
docker compose down
docker compose build --no-cache
docker compose up -d
# 清理未使用的旧镜像 (可选)。每次执行docker compose build --no-cache都会生成新的docker-web镜像
docker image prune -f

# 缓存问题严重时，彻底重置（保留数据卷）：
cd face_sys/docker
docker-compose down
docker-compose build --no-cache
docker-compose up -d
docker exec -it django_web cat /app/.env

# 重置并清空 MySQL 数据（谨慎使用，会删除所有数据）：
cd face_sys/docker
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d


# 防火墙设置 (Firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# 账号安全 (Axes 锁定处理)
# 当用户因多次登录失败被锁定时：
# 命令行解锁：
# 解锁指定用户
docker compose exec web python manage.py axes_reset_username <用户名>
# 解锁所有用户
docker compose exec web python manage.py axes_reset

# 后台手动解锁：
# 登录 Django Admin 后台。
# 找到 Axes -> Access attempts。
# 删除对应用户名/IP 的失败记录即可解锁。