{% extends "unfold/layouts/base_simple.html" %}
{% load i18n static %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[80vh] p-4">
    <div class="w-full max-w-2xl bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700 p-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white flex items-center">
            <span class="material-symbols-outlined mr-2">upload_file</span> 批量导入
        </h2>
        
        <div class="mb-6">
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">选择 Excel/CSV 文件</label>
            <input type="file" id="fileImport" accept=".xlsx,.csv" 
                class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400">
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-300">必须包含列：姓名, 身份证号, 班级, 用户类型</p>
        </div>

        <button onclick="startImport()" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800 w-full">
            开始导入
        </button>

        <!-- 进度条 -->
        <div id="progressArea" class="hidden mt-6">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-blue-700 dark:text-white">处理中...</span>
                <span id="pctText" class="text-sm font-medium text-blue-700 dark:text-white">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                <div id="bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="statusTxt" class="text-xs text-gray-500 mt-2 text-center">正在初始化...</p>
            
            <!-- 错误列表 -->
            <div id="errBox" class="hidden mt-4 p-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
                <span class="font-medium">导入完成，但在以下行发现错误：</span>
                <ul id="errList" class="mt-2 list-disc list-inside"></ul>
            </div>
        </div>
    </div>
</div>

<script>
    function startImport() {
        const file = document.getElementById('fileImport').files[0];
        if(!file) return alert('请选择文件');
        
        const fd = new FormData();
        fd.append('file', file);
        
        document.getElementById('progressArea').classList.remove('hidden');
        
        fetch('/api/batch_import/', {
            method: 'POST',
            body: fd,
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success') track(data.task_id);
            else alert('上传失败');
        });
    }

    function track(tid) {
        const interval = setInterval(() => {
            fetch(`/api/import_progress/${tid}/`).then(r => r.json()).then(res => {
                const d = res.data;
                const total = d.total || 1;
                const current = d.success + d.fail;
                const pct = Math.round((current / total) * 100);
                
                document.getElementById('bar').style.width = pct + '%';
                document.getElementById('pctText').innerText = pct + '%';
                document.getElementById('statusTxt').innerText = `已处理 ${current} / ${total}`;
                
                if(d.status === 'completed' || d.status === 'failed') {
                    clearInterval(interval);
                    document.getElementById('bar').style.width = '100%';
                    
                    if(d.fail > 0) {
                        document.getElementById('errBox').classList.remove('hidden');
                        let html = '';
                        d.details.forEach(i => html += `<li>行 ${i.row}: ${i.msg}</li>`);
                        document.getElementById('errList').innerHTML = html;
                    } else {
                        alert('导入全部成功！');
                        window.location.href = '/admin/core/person/';
                    }
                }
            });
        }, 1000);
    }
</script>
{% endblock %}