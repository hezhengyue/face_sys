{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div id="content-main">
    <div style="padding: 20px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    

        <p style="color: #666; margin-bottom: 20px;">ç‚¹å‡»ä¸‹æ–¹åŒºåŸŸä¸Šä¼ ç…§ç‰‡è¿›è¡Œæ¯”å¯¹ã€‚</p>

        <!-- ä¸‹é¢ä¿æŒåŸæ¥çš„ä»£ç ä¸å˜ -->
        <div style="display: flex; gap: 20px; align-items: flex-start;">
            <!-- å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ -->
            <div style="flex: 1; max-width: 500px;">
                <label for="uploadInput" style="display: block; width: 100%; height: 375px; border: 2px dashed #ccc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #fafafa;">
                    <div id="uploadPlaceholder" style="text-align: center; color: #999;">
                        <!-- SVG å›¾æ ‡ -->
                        <svg style="width: 50px; height: 50px; margin: 0 auto 10px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                    </div>
                    <img id="previewImg" src="" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                </label>
                <input type="file" id="uploadInput" accept="image/jpeg, image/png" style="display: none;">

                <div style="margin-top: 10px;">
                    <button id="searchBtn" class="button" style="padding: 10px 20px; font-size: 16px; background: #417690; color:white; border:none; cursor:pointer;" disabled>ğŸ” å¼€å§‹è¯†åˆ«</button>
                    <span id="status" style="margin-left: 10px; font-weight: bold;"></span>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div style="flex: 1; border: 1px solid #eee; padding: 20px; border-radius: 8px; min-height: 300px;">
                <h3>è¯†åˆ«ç»“æœ</h3>
                <div id="resultArea" style="display: none; text-align: center;">
                    <img id="matchImg" src="" style="width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 3px solid #417690; margin-bottom: 10px;">
                    <h2 id="matchName" style="margin: 0; color: #333;"></h2>
                    <p id="matchInfo" style="color: #666; margin-top: 5px;"></p>
                    <div style="margin-top: 10px; padding: 5px; background: #e8f5e9; color: #2e7d32; display: inline-block; border-radius: 4px;">
                        ç›¸ä¼¼åº¦: <span id="matchScore"></span>%
                    </div>
                </div>
                <div id="noResult" style="color: #999; text-align: center; margin-top: 50px;">
                    æš‚æ— è¯†åˆ«ç»“æœ
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS é€»è¾‘ä¿æŒä¸å˜ -->
<script>
    const uploadInput = document.getElementById('uploadInput');
    const searchBtn = document.getElementById('searchBtn');
    const status = document.getElementById('status');
    const previewImg = document.getElementById('previewImg');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const resultArea = document.getElementById('resultArea');
    const noResult = document.getElementById('noResult');
    let imageBase64 = null;

    uploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) {
            status.innerText = "å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB";
            status.style.color = "red";
            searchBtn.disabled = true;
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
            uploadPlaceholder.style.display = 'none';
            imageBase64 = e.target.result;
            searchBtn.disabled = false;
            status.innerText = "å›¾ç‰‡å·²å‡†å¤‡";
            status.style.color = "green";
        };
        reader.readAsDataURL(file);
    });

    searchBtn.addEventListener('click', () => {
        if (!imageBase64) return;
        status.innerText = "æ­£åœ¨è¯†åˆ«...";
        status.style.color = "#417690";

        fetch('{% url "api_search_face" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ image: imageBase64 })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                status.innerText = "è¯†åˆ«æˆåŠŸï¼";
                status.style.color = "green";
                noResult.style.display = 'none';
                resultArea.style.display = 'block';
                document.getElementById('matchImg').src = data.data.photo_url || '/static/admin/img/icon-unknown.svg';
                document.getElementById('matchName').innerText = data.data.name;
                document.getElementById('matchInfo').innerText = `${data.data.class_name} | ${data.data.id_card}`;
                document.getElementById('matchScore').innerText = parseInt(data.data.score);
            } else {
                status.innerText = data.msg || "æœªåŒ¹é…";
                status.style.color = "red";
                noResult.style.display = 'block';
                resultArea.style.display = 'none';
            }
        })
        .catch(err => {
            console.error(err);
            status.innerText = "ç³»ç»Ÿé”™è¯¯";
        });
    });
</script>
{% endblock %}